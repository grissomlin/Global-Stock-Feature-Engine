name: Only Feature Engineering

on:
  workflow_dispatch:
    inputs:
      market:
        description: 'é¸æ“‡è¦åŠ å·¥çš„å¸‚å ´ (tw / us / cn / hk / jp / kr)'
        required: true
        default: 'tw'
        type: choice
        options: [tw, us, cn, hk, jp, kr]

jobs:
  process:
    runs-on: ubuntu-latest
    
    # è¨­å®šç’°å¢ƒè®Šæ•¸ï¼Œè®“ only_feature.py å…§çš„ Google Drive åŠŸèƒ½å¯ä»¥é‹ä½œ
    env:
      GDRIVE_SERVICE_ACCOUNT: ${{ secrets.GDRIVE_SERVICE_ACCOUNT }}
      GDRIVE_FOLDER_ID: ${{ secrets.GDRIVE_FOLDER_ID }}

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install Dependencies
        run: |
          python -m pip install --upgrade pip
          # ğŸ’¡ ä½¿ç”¨ requirements.txt å®‰è£ä»¥è§£æ±º ModuleNotFoundError: No module named 'google'
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
          # é¡å¤–ç¢ºä¿æ ¸å¿ƒå¥—ä»¶å­˜åœ¨
          pip install pandas numpy google-api-python-client google-auth-httplib2 google-auth-oauthlib python-dotenv

      # ğŸš€ é—œéµï¼šå¾å¿«å–æŠ“å›èˆŠçš„è³‡æ–™åº«æª”æ¡ˆ
      - name: ğŸ’¾ Restore DB Cache
        uses: actions/cache@v3
        with:
          path: "*.db"
          # ä½¿ç”¨ v3 ç‰ˆæœ¬å‰ç¶´ï¼Œä¸¦åŠ ä¸Š run_id ç¢ºä¿èƒ½åŒ¹é…åˆ°æœ€æ–°çš„æˆåŠŸå¿«å–
          key: ${{ github.event.inputs.market }}-db-v3-${{ github.run_id }}
          restore-keys: |
            ${{ github.event.inputs.market }}-db-v3-

      - name: ğŸ§ª Run Processing & Sync to Cloud
        run: |
          # ä½¿ç”¨ -u è®“ Log å³æ™‚å°å‡º
          # åŸ·è¡Œ only_feature.pyï¼Œè©²è…³æœ¬æ‡‰åŒ…å« process_market_data èˆ‡ upload_db_to_drive
          python -u only_feature.py ${{ github.event.inputs.market }}

      # ğŸ“¢ é¸é…ï¼šå¦‚æœåŠ å·¥æˆåŠŸï¼Œè§¸ç™¼å¦ä¸€å€‹ Repo çš„é€£å‹• (ç¶­æŒä½ åŸæœ¬ main.yml çš„é‚è¼¯)
      - name: ğŸ“¢ Trigger Alpha Data Lab Sync
        if: success()
        env:
          GH_PAT: ${{ secrets.GH_PAT }}
        run: |
          DB_NAME="${{ github.event.inputs.market }}_stock_warehouse"
          echo "ğŸš€ å¸‚å ´ ${{ github.event.inputs.market }} åŠ å·¥å®Œæˆï¼Œé€šçŸ¥ Alpha Data Lab..."
          curl -X POST https://api.github.com/repos/grissomlin/Alpha-Data-Cleaning-Lab/dispatches \
          -H "Accept: application/vnd.github.v3+json" \
          -H "Authorization: bearer $GH_PAT" \
          -d "{\"event_type\": \"warehouse_sync_complete\", \"client_payload\": {\"market_db\": \"$DB_NAME\"}}"
