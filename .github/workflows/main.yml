name: Market Data Monitor (Single/All)

on:
  workflow_dispatch:
    inputs:
      market:
        description: 'é¸æ“‡è¦åŸ·è¡Œçš„å¸‚å ´ (Select Market)'
        required: true
        default: 'all'
        type: choice
        options:
          - all
          - tw
          - us
          - cn
          - hk
          - jp
          - kr
  schedule:
    - cron: '0 6 * * 1-5' # å°åŒ—æ™‚é–“ 14:00 è‡ªå‹•åŸ·è¡Œå…¨éƒ¨å¸‚å ´

jobs:
  run-market-sync:
    runs-on: ubuntu-latest
    timeout-minutes: 240
    
    env:
      TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
      TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
      GDRIVE_SERVICE_ACCOUNT: ${{ secrets.GDRIVE_SERVICE_ACCOUNT }}
      GDRIVE_FOLDER_ID: ${{ secrets.GDRIVE_FOLDER_ID }}
      # å¦‚æœ main.py å…§æœ‰ç”¨åˆ°ç’°å¢ƒè®Šæ•¸è®€å–ï¼Œè«‹ç¢ºä¿é€™è£¡æœ‰å°æ‡‰

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          # ğŸ’¡ ä¿®æ­£ï¼šç§»é™¤ sqlite3 (å…§å»ºåº«ä¸å¯ pip install)
          if [ -f requirements.txt ]; then 
            pip install -r requirements.txt
          else
            pip install pandas numpy yfinance tqdm python-dotenv scipy requests lxml
            pip install google-api-python-client google-auth-httplib2 google-auth-oauthlib
            pip install pykrx finance-datareader akshare
          fi

      - name: Run Market Update
        run: |
          # å–å¾—æ‰‹å‹•é¸æ“‡æˆ–é è¨­å€¼
          TARGET_MARKET="${{ github.event.inputs.market }}"
          
          # å¦‚æœæ˜¯ schedule (å®šæ™‚ä»»å‹™) è§¸ç™¼ï¼ŒTARGET_MARKET æœƒæ˜¯ç©ºçš„ï¼Œå¼·åˆ¶è¨­ç‚º all
          if [ -z "$TARGET_MARKET" ]; then 
            TARGET_MARKET="all"
          fi
          
          echo "ğŸŒ åŸ·è¡Œç›®æ¨™å¸‚å ´: $TARGET_MARKET"
          
          if [ "$TARGET_MARKET" == "all" ]; then
            # åŸ·è¡Œå…¨éƒ¨ (main.py ä¸å¸¶åƒæ•¸é è¨­è·‘å…¨éƒ¨)
            python -u main.py
          else
            # åŸ·è¡Œå–®ä¸€å¸‚å ´ (ä¾‹å¦‚: python main.py tw)
            python -u main.py $TARGET_MARKET
          fi

      - name: Upload Database Artifact
        if: always() # å³ä½¿éƒ¨åˆ†æˆåŠŸä¹Ÿä¸Šå‚³ï¼Œæ–¹ä¾¿æª¢æŸ¥æª”æ¡ˆ
        uses: actions/upload-artifact@v4
        with:
          name: stock-databases-${{ github.run_id }}
          path: "*.db"
          retention-days: 3

      - name: Notify Failure
        if: failure()
        run: |
          echo "âŒ å¸‚å ´åŒæ­¥å¤±æ•—ï¼Œè«‹æª¢æŸ¥ Logï¼"
