name: Global Stock Matrix Monitor

on:
  workflow_dispatch:  # ç°¡å–®æ‰‹å‹•è§¸ç™¼
  schedule:
    - cron: '0 6 * * 1-5' # å°åŒ—æ™‚é–“ 14:00 åŸ·è¡Œï¼ˆé€±ä¸€è‡³é€±äº”ï¼‰

jobs:
  # åŸ·è¡Œæ‰€æœ‰å¸‚å ´çš„çŸ©é™£ä»»å‹™
  run-market-sync:
    runs-on: ubuntu-latest
    timeout-minutes: 240
    strategy:
      fail-fast: false
      matrix:
        market: ['tw', 'us', 'cn', 'hk', 'jp', 'kr']
    
    env:
      TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
      TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
      RESEND_API_KEY: ${{ secrets.RESEND_API_KEY }}
      GDRIVE_SERVICE_ACCOUNT: ${{ secrets.GDRIVE_SERVICE_ACCOUNT }}
      GH_PAT: ${{ secrets.GH_PAT }}
      GDRIVE_FOLDER_ID: ${{ secrets.GDRIVE_FOLDER_ID }}

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          # å®‰è£åŸºç¤å¥—ä»¶
          if [ -f requirements.txt ]; then 
            pip install -r requirements.txt
          else
            # å¦‚æœæ²’æœ‰ requirements.txtï¼Œå®‰è£åŸºæœ¬éœ€è¦çš„å¥—ä»¶
            pip install pandas numpy yfinance tqdm python-dotenv sqlite3
            pip install google-api-python-client google-auth-httplib2 google-auth-oauthlib
          fi

      - name: Run Market Update
        run: |
          echo "ğŸš€ é–‹å§‹åŒæ­¥ ${{ matrix.market }} å¸‚å ´..."
          python -u main.py ${{ matrix.market }}
          echo "âœ… ${{ matrix.market }} å¸‚å ´åŒæ­¥å®Œæˆ"

      - name: Save Market Summary
        if: always()
        run: |
          market=${{ matrix.market }}
          # ç¢ºä¿æ¯å€‹å¸‚å ´çš„æ‘˜è¦æ–‡ä»¶å­˜åœ¨
          if [ ! -f "summary_$market.json" ]; then
            echo "âš ï¸ æœªæ‰¾åˆ° summary_$market.jsonï¼Œå‰µå»ºé è¨­æ–‡ä»¶"
            echo '{
              "market": "'"$market"'",
              "success": 0,
              "coverage": "0%",
              "status": "âŒ æœªåŒæ­¥",
              "end_date": "å°šæœªåŒæ­¥"
            }' > "summary_$market.json"
          fi
          
          # ä¸Šå‚³æ‘˜è¦æ–‡ä»¶ä½œç‚º artifact
          echo "ğŸ“ ä¿å­˜ summary_$market.json ä½œç‚º artifact"

      - name: Upload Market Summary Artifact
        uses: actions/upload-artifact@v4
        with:
          name: summary-${{ matrix.market }}
          path: summary_${{ matrix.market }}.json
          retention-days: 7

      - name: Upload Database Artifact
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: db-${{ matrix.market }}
          path: ${{ matrix.market }}_stock_warehouse.db
          retention-days: 7

      - name: Trigger Alpha Data Lab
        if: success()
        run: |
          DB_NAME="${{ matrix.market }}_stock_warehouse"
          echo "ğŸ”— è§¸ç™¼ Alpha Data Lab åŒæ­¥: $DB_NAME"
          # é€™è£¡ä¿ç•™æ‚¨çš„ Alpha Data Lab è§¸ç™¼é‚è¼¯
          # curl -X POST ...

      - name: Notify Failure
        if: failure()
        run: |
          market=${{ matrix.market }}
          echo "âŒ $market å¸‚å ´åŒæ­¥å¤±æ•—"
          # é€™è£¡å¯ä»¥æ·»åŠ  Telegram é€šçŸ¥

  # åˆä½µæ‰€æœ‰å¸‚å ´æ‘˜è¦
  merge-summaries:
    needs: run-market-sync
    runs-on: ubuntu-latest
    if: always()  # å³ä½¿æœ‰å¸‚å ´ä»»å‹™å¤±æ•—ä¹ŸåŸ·è¡Œ

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Download All Market Summaries
        uses: actions/download-artifact@v4
        with:
          path: artifact-downloads

      - name: Merge Global Summary
        run: |
          echo "ğŸ”— åˆä½µæ‰€æœ‰å¸‚å ´æ‘˜è¦..."
          
          # å‰µå»ºåˆä½µå¾Œçš„æ•¸æ“š
          all_summaries=[]
          
          for market in tw us cn hk jp kr; do
            file_path="artifact-downloads/summary-$market/summary_$market.json"
            
            if [ -f "$file_path" ]; then
              echo "âœ… æ‰¾åˆ° $market çš„æ‘˜è¦æ–‡ä»¶"
              # è®€å– JSON æ–‡ä»¶å…§å®¹
              content=$(cat "$file_path")
              all_summaries+=("$content")
            else
              echo "âš ï¸ æœªæ‰¾åˆ° $market çš„æ‘˜è¦æ–‡ä»¶ï¼Œä½¿ç”¨é è¨­"
              all_summaries+=('{"market": "'$market'", "success": 0, "coverage": "0%", "status": "âŒ æœªåŒæ­¥", "end_date": "å°šæœªåŒæ­¥"}')
            fi
          done
          
          # å‰µå»º JSON æ•¸çµ„
          echo "[" > global_summary.json
          for ((i=0; i<${#all_summaries[@]}; i++)); do
            echo "${all_summaries[i]}" >> global_summary.json
            if [ $i -lt $((${#all_summaries[@]}-1)) ]; then
              echo "," >> global_summary.json
            fi
          done
          echo "]" >> global_summary.json
          
          echo "âœ… å·²ç”Ÿæˆ global_summary.json"

      - name: Upload Global Summary
        uses: actions/upload-artifact@v4
        with:
          name: global-summary
          path: global_summary.json
          retention-days: 30

      - name: Commit Global Summary to Repository
        run: |
          echo "ğŸ“ æäº¤ global_summary.json åˆ°å€‰åº«..."
          
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          git add global_summary.json
          
          if git diff --cached --quiet; then
            echo "æ²’æœ‰è®Šæ›´å¯æäº¤"
          else
            git commit -m "ğŸ“Š æ›´æ–°å…¨çƒå¸‚å ´æ‘˜è¦ [skip ci]"
            git push
            echo "âœ… å·²æäº¤ä¸¦æ¨é€ global_summary.json"
          fi
