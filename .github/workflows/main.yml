name: Market Data Monitor (Single/All)

on:
  workflow_dispatch:
    inputs:
      market:
        description: 'é¸æ“‡è¦åŸ·è¡Œçš„å¸‚å ´'
        required: true
        default: 'tw'
        type: choice
        options:
          - all
          - tw
          - us
          - cn
          - hk
          - jp
          - kr
  schedule:
    - cron: '0 6 * * 1-5' # å°åŒ—æ™‚é–“ 14:00 è‡ªå‹•è·‘å…¨éƒ¨

jobs:
  run-market-sync:
    runs-on: ubuntu-latest
    timeout-minutes: 240
    
    env:
      TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
      TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
      GDRIVE_SERVICE_ACCOUNT: ${{ secrets.GDRIVE_SERVICE_ACCOUNT }}
      GDRIVE_FOLDER_ID: ${{ secrets.GDRIVE_FOLDER_ID }}

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pandas numpy yfinance tqdm python-dotenv sqlite3 scipy
          pip install google-api-python-client google-auth-httplib2 google-auth-oauthlib
          # è‹¥æœ‰ pykrx (éŸ“è‚¡éœ€ç”¨åˆ°) æˆ–å…¶ä»–å¥—ä»¶ä¹Ÿè«‹åŠ å…¥
          pip install pykrx

      - name: Run Market Update
        run: |
          # åˆ¤æ–·æ˜¯æ‰‹å‹•è¼¸å…¥é‚„æ˜¯æ’ç¨‹è§¸ç™¼
          TARGET_MARKET="${{ github.event.inputs.market }}"
          if [ -z "$TARGET_MARKET" ]; then TARGET_MARKET="all"; fi
          
          echo "ğŸš€ åŸ·è¡Œç›®æ¨™: $TARGET_MARKET"
          
          if [ "$TARGET_MARKET" == "all" ]; then
            python -u main.py
          else
            python -u main.py $TARGET_MARKET
          fi

      - name: Upload Database Artifact
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: stock-databases
          path: "*.db"
          retention-days: 3
