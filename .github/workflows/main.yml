name: Global Stock Matrix Monitor

on:
  workflow_dispatch:
    inputs:
      market:
        description: 'é¸æ“‡åŸ·è¡Œå¸‚å ´ (all / tw / us / cn / hk / jp / kr)'
        required: true
        default: 'all'
        type: choice
        options: [all, tw, us, cn, hk, jp, kr]
  schedule:
    - cron: '0 6 * * 1-5' # å°åŒ—æ™‚é–“ 14:00 åŸ·è¡Œ

jobs:
  prepare-matrix:
    runs-on: ubuntu-latest
    outputs:
      matrix_list: ${{ steps.set-matrix.outputs.matrix_list }}
    steps:
      - id: set-matrix
        run: |
          if [[ "${{ github.event.inputs.market }}" == "all" || "${{ github.event_name }}" == "schedule" ]]; then
            echo "matrix_list=[\"tw\", \"us\", \"cn\", \"hk\", \"jp\", \"kr\"]" >> $GITHUB_OUTPUT
          else
            echo "matrix_list=[\"${{ github.event.inputs.market }}\"]" >> $GITHUB_OUTPUT
          fi

  execute-task:
    needs: prepare-matrix
    runs-on: ubuntu-latest
    timeout-minutes: 180 
    strategy:
      fail-fast: false
      matrix:
        market: ${{ fromJson(needs.prepare-matrix.outputs.matrix_list) }}
    
    env:
      TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
      TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
      RESEND_API_KEY: ${{ secrets.RESEND_API_KEY }}
      GDRIVE_SERVICE_ACCOUNT: ${{ secrets.GDRIVE_SERVICE_ACCOUNT }}
      GH_PAT: ${{ secrets.GH_PAT }}
      # ğŸ’¡ æ ¸å¿ƒä¿®æ­£ï¼šæ­£å¼åŠ å…¥ Google Drive è³‡æ–™å¤¾ ID è®Šæ•¸
      GDRIVE_FOLDER_ID: ${{ secrets.GDRIVE_FOLDER_ID }}

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
          # ç¢ºä¿æ‰€æœ‰åˆ†ææ‰€éœ€çš„å¥—ä»¶éƒ½å®‰è£åˆ°ä½
          pip install resend google-api-python-client google-auth-httplib2 google-auth-oauthlib python-dotenv pandas-ta tqdm yfinance numpy pandas

      # ğŸš€ è³‡æ–™åº«æª”æ¡ˆå¿«å– (GitHub Cache)
      # å¢åŠ  v2 æ¨™ç±¤ä»¥é¿å…èˆ‡ä¹‹å‰å¤±æ•—çš„ç›®éŒ„æ··æ·†
      - name: ğŸ’¾ Restore Market Database Cache
        id: db-cache
        uses: actions/cache@v3
        with:
          path: |
            *.db
          key: ${{ matrix.market }}-db-v2-${{ github.run_id }}
          restore-keys: |
            ${{ matrix.market }}-db-v2-

      - name: Run Market Update
        run: |
          # ä½¿ç”¨ -u è®“ Python å³æ™‚å°å‡º Log
          python -u main.py ${{ matrix.market }}

      # ğŸ“¢ è§¸ç™¼é€£å‹•ï¼šç²¾ç…‰æ•¸æ“š
      - name: ğŸ“¢ Trigger Alpha Data Lab Sync
        if: success()
        run: |
          DB_NAME="${{ matrix.market }}_stock_warehouse"
          echo "ğŸš€ å¸‚å ´ ${{ matrix.market }} æ›´æ–°æˆåŠŸï¼Œæ­£åœ¨é ç«¯è§¸ç™¼ç²¾ç…‰ $DB_NAME..."
          curl -X POST https://api.github.com/repos/grissomlin/Alpha-Data-Cleaning-Lab/dispatches \
          -H "Accept: application/vnd.github.v3+json" \
          -H "Authorization: bearer $GH_PAT" \
          -d "{\"event_type\": \"warehouse_sync_complete\", \"client_payload\": {\"market_db\": \"$DB_NAME\"}}"

      - name: Notify System Failure
        if: failure()
        run: |
          python -c "
          import os, requests
          token = os.getenv('TELEGRAM_BOT_TOKEN')
          chat_id = os.getenv('TELEGRAM_CHAT_ID')
          market = '${{ matrix.market }}'.upper()
          msg = f'âŒ ã€ç³»çµ±å´©æ½°ã€‘å¸‚å ´: {market}\nåŸå› ï¼šGitHub Actions åŸ·è¡Œå¤±æ•—ï¼Œè«‹æª¢æŸ¥æ—¥èªŒã€‚'
          if token and chat_id:
              requests.post(f'https://api.telegram.org/bot{token}/sendMessage', json={'chat_id': chat_id, 'text': msg})
          "
