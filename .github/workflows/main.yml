name: Global Stock Matrix Monitor

on:
  workflow_dispatch:
    inputs:
      market:
        description: 'é¸æ“‡åŸ·è¡Œå¸‚å ´ (all / tw / us / cn / hk / jp / kr)'
        required: true
        default: 'all'
        type: choice
        options: [all, tw, us, cn, hk, jp, kr]
  schedule:
    - cron: '0 6 * * 1-5' # å°åŒ—æ™‚é–“ 14:00 åŸ·è¡Œ

jobs:
  prepare-matrix:
    runs-on: ubuntu-latest
    outputs:
      matrix_list: ${{ steps.set-matrix.outputs.matrix_list }}
    steps:
      - id: set-matrix
        run: |
          if [[ "${{ github.event.inputs.market }}" == "all" || "${{ github.event_name }}" == "schedule" ]]; then
            echo "matrix_list=[\"tw\", \"us\", \"cn\", \"hk\", \"jp\", \"kr\"]" >> $GITHUB_OUTPUT
          else
            echo "matrix_list=[\"${{ github.event.inputs.market }}\"]" >> $GITHUB_OUTPUT
          fi

  execute-task:
    needs: prepare-matrix
    runs-on: ubuntu-latest
    timeout-minutes: 180 
    strategy:
      fail-fast: false
      matrix:
        market: ${{ fromJson(needs.prepare-matrix.outputs.matrix_list) }}
    
    env:
      TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
      TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
      RESEND_API_KEY: ${{ secrets.RESEND_API_KEY }}
      GDRIVE_SERVICE_ACCOUNT: ${{ secrets.GDRIVE_SERVICE_ACCOUNT }}
      GH_PAT: ${{ secrets.GH_PAT }}
      GDRIVE_FOLDER_ID: ${{ secrets.GDRIVE_FOLDER_ID }}

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          # ğŸ’¡ ä¿®æ­£ 1ï¼šå…ˆå®‰è£ requirements.txt å…§çš„åŸºç¤å¥—ä»¶
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
          # ğŸ’¡ ä¿®æ­£ 2ï¼šæ‰‹å‹•è£œå¼·æ ¸å¿ƒåˆ†æå¥—ä»¶ï¼Œä¸¦æ’é™¤å ±éŒ¯çš„ pandas-ta
          pip install yfinance tqdm pandas numpy python-dotenv resend google-api-python-client google-auth-httplib2 google-auth-oauthlib

      - name: ğŸ’¾ Restore Market Database Cache
        id: db-cache
        uses: actions/cache@v3
        with:
          path: |
            *.db
          # ğŸ’¡ ä¿®æ­£ 3ï¼šæ›´æ› Key ç‰ˆæœ¬ï¼ˆv3ï¼‰å¼·è¿«æ¸…é™¤ä¹‹å‰çš„æå£å¿«å–
          key: ${{ matrix.market }}-db-v3-${{ github.run_id }}
          restore-keys: |
            ${{ matrix.market }}-db-v3-

      - name: Run Market Update
        run: |
          # ä½¿ç”¨ -u è®“ Python å³æ™‚å°å‡º Logï¼Œæ–¹ä¾¿åœ¨ Action ä»‹é¢ç›£æ§é€²åº¦
          python -u main.py ${{ matrix.market }}

      - name: ğŸ“¢ Trigger Alpha Data Lab Sync
        if: success()
        run: |
          DB_NAME="${{ matrix.market }}_stock_warehouse"
          curl -X POST https://api.github.com/repos/grissomlin/Alpha-Data-Cleaning-Lab/dispatches \
          -H "Accept: application/vnd.github.v3+json" \
          -H "Authorization: bearer $GH_PAT" \
          -d "{\"event_type\": \"warehouse_sync_complete\", \"client_payload\": {\"market_db\": \"$DB_NAME\"}}"

      - name: Notify System Failure
        if: failure()
        run: |
          python -c "
          import os, requests
          token = os.getenv('TELEGRAM_BOT_TOKEN')
          chat_id = os.getenv('TELEGRAM_CHAT_ID')
          market = '${{ matrix.market }}'.upper()
          msg = f'âŒ ã€ç³»çµ±å´©æ½°ã€‘å¸‚å ´: {market}\nåŸå› ï¼šGitHub Actions åŸ·è¡Œå¤±æ•—ã€‚'
          if token and chat_id:
              requests.post(f'https://api.telegram.org/bot{token}/sendMessage', json={'chat_id': chat_id, 'text': msg})
          "

  # ğŸ’¡ æ–°å¢ï¼šåˆä½µå…¨çƒå¸‚å ´æ‘˜è¦ä»»å‹™
  merge-global-summary:
    needs: execute-task  # ç­‰å¾…æ‰€æœ‰å¸‚å ´ä»»å‹™å®Œæˆ
    runs-on: ubuntu-latest
    if: always()  # å³ä½¿æœ‰å¸‚å ´ä»»å‹™å¤±æ•—ä¹ŸåŸ·è¡Œåˆä½µ
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Download all market summary files
        # ç”±æ–¼æ¯å€‹å¸‚å ´ä»»å‹™å¯èƒ½åœ¨ä¸åŒçš„ runner ä¸ŠåŸ·è¡Œï¼Œæˆ‘å€‘éœ€è¦ä¸‹è¼‰æ‰€æœ‰å¸‚å ´çš„æ‘˜è¦æ–‡ä»¶
        # é€™è£¡å‡è¨­æ¯å€‹å¸‚å ´çš„æ‘˜è¦æ–‡ä»¶å·²ç¶“è¢«ä¿å­˜åœ¨å·¥ä½œå€ä¸­
        run: |
          echo "æ­£åœ¨æ”¶é›†æ‰€æœ‰å¸‚å ´çš„æ‘˜è¦æ–‡ä»¶..."
          # å‰µå»ºä¸€å€‹æ•¸çµ„åŒ…å«æ‰€æœ‰å¸‚å ´
          markets=("tw" "us" "cn" "hk" "jp" "kr")
          for market in "${markets[@]}"; do
            if [ -f "summary_${market}.json" ]; then
              echo "âœ… æ‰¾åˆ° ${market} å¸‚å ´çš„æ‘˜è¦æ–‡ä»¶"
            else
              # å¦‚æœæ–‡ä»¶ä¸å­˜åœ¨ï¼Œå‰µå»ºä¸€å€‹é è¨­çš„æ‘˜è¦æ–‡ä»¶
              echo "âš ï¸ æœªæ‰¾åˆ° ${market} å¸‚å ´çš„æ‘˜è¦æ–‡ä»¶ï¼Œå‰µå»ºé è¨­æ‘˜è¦"
              echo '{
                "market": "'"$market"'",
                "success": 0,
                "coverage": "0%",
                "status": "âŒ æœªåŒæ­¥",
                "end_date": "å°šæœªåŒæ­¥"
              }' > "summary_${market}.json"
            fi
          done

      - name: åˆä½µå…¨çƒå¸‚å ´æ‘˜è¦
        run: |
          python -c "
import json
import os

# å¸‚å ´åˆ—è¡¨
market_list = ['tw', 'us', 'cn', 'hk', 'jp', 'kr']
summary_data = []

for market in market_list:
    filename = f'summary_{market}.json'
    try:
        if os.path.exists(filename):
            with open(filename, 'r', encoding='utf-8') as f:
                data = json.load(f)
                summary_data.append(data)
        else:
            # å‰µå»ºé è¨­ç‹€æ…‹
            summary_data.append({
                'market': market.upper(),
                'success': 0,
                'coverage': '0%',
                'status': 'âŒ æœªåŒæ­¥',
                'end_date': 'å°šæœªåŒæ­¥'
            })
    except Exception as e:
        print(f'è®€å– {filename} å¤±æ•—: {e}')
        summary_data.append({
            'market': market.upper(),
            'success': 0,
            'coverage': '0%',
            'status': 'âŒ è®€å–å¤±æ•—',
            'end_date': 'éŒ¯èª¤'
        })

# å¯«å…¥åˆä½µå¾Œçš„ global_summary.json
with open('global_summary.json', 'w', encoding='utf-8') as f:
    json.dump(summary_data, f, ensure_ascii=False, indent=2)

print(f'âœ… å·²åˆä½µ {len(summary_data)} å€‹å¸‚å ´çš„æ‘˜è¦æ•¸æ“š')
print('åˆä½µçµæœ:')
for item in summary_data:
    print(f"  {item['market']}: {item['status']} ({item['success']}å®¶, {item['coverage']})")
          "

      - name: Upload global summary as artifact
        uses: actions/upload-artifact@v4
        with:
          name: global-summary
          path: global_summary.json
          retention-days: 7

      - name: Commit global summary to repo
        # å°‡åˆä½µå¾Œçš„ global_summary.json æäº¤å›å€‰åº«
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add global_summary.json
          git commit -m "ğŸ“Š æ›´æ–°å…¨çƒå¸‚å ´æ‘˜è¦ [skip ci]" || echo "æ²’æœ‰è®Šæ›´å¯æäº¤"
          git push
