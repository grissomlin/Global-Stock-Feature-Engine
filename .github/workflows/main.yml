name: Market Data Monitor (Parallel Matrix)

on:
  workflow_dispatch:
    inputs:
      market:
        description: 'é¸æ“‡è¦åŸ·è¡Œçš„å¸‚å ´ (Select Market)'
        required: true
        default: 'all'
        type: choice
        options:
          - all
          - tw
          - us
          - cn
          - hk
          - jp
          - kr
  schedule:
    - cron: '0 6 * * 1-5' # å°åŒ—æ™‚é–“ 14:00 è‡ªå‹•åŸ·è¡Œ

jobs:
  prepare:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
    steps:
      - id: set-matrix
        run: |
          # åˆ¤æ–·è¼¸å…¥ï¼Œå¦‚æœæ˜¯ all å°±è¼¸å‡ºå®Œæ•´åˆ—è¡¨ï¼Œå¦å‰‡è¼¸å‡ºå–®ä¸€æ¨™ç±¤
          INPUT="${{ github.event.inputs.market }}"
          if [ "$INPUT" == "" ]; then INPUT="all"; fi # è™•ç†æ’ç¨‹è§¸ç™¼

          if [ "$INPUT" == "all" ]; then
            echo 'matrix=["tw", "us", "cn", "hk", "jp", "kr"]' >> $GITHUB_OUTPUT
          else
            echo "matrix=[\"$INPUT\"]" >> $GITHUB_OUTPUT
          fi

  run-market-sync:
    needs: prepare
    runs-on: ubuntu-latest
    timeout-minutes: 240
    strategy:
      fail-fast: false # å…¶ä¸­ä¸€å°å¤±æ•—ï¼Œå…¶ä»–å°ç¹¼çºŒè·‘
      matrix:
        market: ${{ fromJson(needs.prepare.outputs.matrix) }}
    
    env:
      TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
      TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
      GDRIVE_SERVICE_ACCOUNT: ${{ secrets.GDRIVE_SERVICE_ACCOUNT }}
      GDRIVE_FOLDER_ID: ${{ secrets.GDRIVE_FOLDER_ID }}

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then 
            pip install -r requirements.txt
          else
            pip install pandas numpy yfinance tqdm python-dotenv scipy requests lxml
            pip install google-api-python-client google-auth-httplib2 google-auth-oauthlib
            pip install pykrx finance-datareader akshare
          fi

      - name: Run Market Update
        run: |
          echo "ğŸŒ æ­£åœ¨é–‹æ©ŸåŸ·è¡Œç›®æ¨™å¸‚å ´: ${{ matrix.market }}"
          # ğŸ’¡ é—œéµï¼šç¾åœ¨æ¯å°æ©Ÿå™¨åªè·‘ matrix å‚³é€²ä¾†çš„é‚£å€‹åƒæ•¸
          python -u main.py ${{ matrix.market }}

      - name: Upload Database Artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: db-${{ matrix.market }}-${{ github.run_id }}
          path: "*.db"
          retention-days: 3
